{% extends 'player/header.html' %}
{% load static %}
{% load bootstrap3 %}
{% load i18n %}
{% block for_scripts_and_css %}
{% load dict_key %}
{% load get_attr %}
<script src="{% bootstrap_jquery_url %}"></script>
{% bootstrap_javascript %}
{% bootstrap_css %}
<link rel="stylesheet" href='{% static "overview.css" %}?{{ csrf_token }}'>
{% endblock %}

{% block content %}
{% if player.account.groups.all.0.name == "chat_moderator" %}
<script>
    const ban_button = "{% if request.user.is_superuser %} <input type='button' class='message__ban' value='отключить чат'>{% endif %}";
</script>
{% endif %}
<div class="row">
    Привет, {{ player }} !
    <br>
    <!--если игрок в полете-->
    {% if player.destination %}
    Вы летите в регион {{ player.destination }}
    {% else %}
    Ты находишься в регионе {{ player.region }}
    {% endif %}
    {% get_current_language as LANGUAGE_CODE %}
    {% get_language_info for LANGUAGE_CODE as lang %}
    <!-- Tabs -->
    {{ LANGUAGE_CODE|json_script:"room-name" }}
    {{ player.pk|json_script:"player_id" }}
    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#{{ language.code }}"><img
                src="/static/img/{{ LANGUAGE_CODE }}.png" width="30" height="30"> {{ lang.name_local }}</a></li>
    </ul>
    <div class="tab-content">
        <div id="{{ LANGUAGE_CODE }}" class="tab-pane fade in active" >
            <section id="chat-log-{{ LANGUAGE_CODE }}" class="chat" style="height: 50vh; flex: 10 10 auto; overflow-x: hidden; overflow-y: auto;">
                {% if not player.chat_ban %}
                    {% for message in messages %}
                        {% if message|dict_key:'content' != 'ban_chat' %}
                <div class="row">
                    <div class='message {% if message|dict_key:"author" == player.pk %}message--user-2{% else %}message--user-1{% endif %}' data-sender='{{  message|dict_key:"author" }}'>
                        <time class='message__time'>
                            {{ message|dict_key:'dtime' }}
                            {% if player.account.groups.all.0.name == "chat_moderator" %}
                                {% if message|dict_key:"author" != player.pk %}
                            <input type='button' class='message__ban' value='отключить чат'>
                                {% endif %}
                            {% endif %}
                        </time>
                        <figure class='message__author-pic'>
                            <a href='/profile/{{  message|dict_key:"author" }}' target='_blank'>
                                <img src="{{  message|dict_key:'image_link'  }}" width='50px' height='50px'>
                            </a>
                        </figure>
                        <div class='message__text'>
                            <p>{{ message|dict_key:'content' }}</p>
                        </div>
                    </div>
                </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </section>
            <script>
                document.getElementById('chat-log-{{ LANGUAGE_CODE }}').scrollTop = document.getElementById('chat-log-{{ LANGUAGE_CODE }}').scrollHeight;
            </script>
            <div style="display: flex">
                <div style="flex: 10 10 auto">
                    <input id="chat-message-input-{{ LANGUAGE_CODE }}" type="text" size="100" style="width: 100%">
                </div>
                <div style="flex: 1 1 auto">
                    <input id="chat-message-submit-{{ LANGUAGE_CODE }}" type="button" value="Отправить" class="chat-button"
                           style="width: 100%">
                </div>
            </div>
        </div>
    </div>
    <script>
    const chat_conn_type = "{% if http_use %}ws{% else %}wss{% endif %}";
    </script>
    <script src='{% static "chat.js" %}?{{ csrf_token }}'></script>
    {% if player.account.groups.all.0.name == "chat_moderator" %}
    <script src='{% static "chat_admin.js" %}?{{ csrf_token }}'></script>
    {% endif %}
</div>
{% endblock %}
