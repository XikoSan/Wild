{% extends 'player/redesign/header.html' %}
{% load get_mul %}
{% load dict_key %}
{% load static %}
{% load get_sum %}
{% load get_mod %}
{% load l10n %}{% load i18n %}

{% block content %}
<script>
    const chat_conn_type = "{% if http_use %}ws{% else %}wss{% endif %}";

    const conn_header = '{% trans 'Соединение прервалось' context "lootbox" %}';
    const conn_body = '{% trans 'Перезагрузите страницу, чтобы переподключиться' context "lootbox" %}';
    const conn_ok = "{% trans 'Понятно' context "lootbox" %}";
</script>
<script src='{% static "js/redesign/lootbox_socket.js" %}'></script>
<section class="box custom-scroll">
    <!-- Заголовок -->
    <h1 class="box__title ct__page-title">{% trans 'Ледяные сундуки' context "lootbox" %}</h1>

    <div class="articles__tabs" style="max-width: 600rem;margin: 0 auto;padding: 0 12rem;grid-template-columns: repeat(2, 1fr);">
        <button class="ct__top-tab ct__top-tab1 active">{% trans 'сундуки' context "lootbox" %}</button>
        <button class="ct__top-tab ct__top-tab2">{% trans 'получить' context "lootbox" %}</button>
<!--        <button class="ct__top-tab ct__top-tab3">{% trans 'история' context "lootbox" %}</button>-->
    </div>

    <div class="DecorLine"></div>

    <!-- Блок "Мои сундуки" -->
    <div class="box__block active">
        <p class="box__desc">
            {% trans 'Открывайте Ледяные сундуки и богатейте!' context "lootbox" %}
        </p>

        <div class="box__pic">
            <img class="box__picImg" src="{% static 'img/ice_chest.png' %}" alt="" style="object-fit: contain">

            <button class="box__picBtn">
                <span>{% trans 'У вас нет сундуков' context "lootbox" %}</span>
                <svg width="90" height="90" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M45 0C33.0653 3.35549e-05 21.6194 4.7411 13.1802 13.1802C4.7411 21.6194 3.35549e-05 33.0653 0 45C3.34951e-05 56.9347 4.7411 68.3806 13.1802 76.8198C21.6194 85.2589 33.0653 90 45 90C56.9347 90 68.3806 85.2589 76.8198 76.8198C85.2589 68.3806 90 56.9347 90 45C90 33.0653 85.2589 21.6194 76.8198 13.1802C68.3806 4.7411 56.9347 3.34951e-05 45 0ZM45 8.01812C54.8082 8.01815 64.2147 11.9145 71.1501 18.8499C78.0855 25.7853 81.9818 35.1918 81.9819 45C81.9818 54.8082 78.0855 64.2147 71.1501 71.1501C64.2147 78.0855 54.8082 81.9818 45 81.9819C35.1918 81.9818 25.7853 78.0855 18.8499 71.1501C11.9145 64.2147 8.01815 54.8082 8.01812 45C8.01815 35.1918 11.9145 25.7853 18.8499 18.8499C25.7853 11.9145 35.1918 8.01815 45 8.01812ZM44.5345 24.7951C42.5323 24.7951 40.9205 26.4069 40.9205 28.4091V40.9205H28.4091C26.4069 40.9205 24.7951 42.5323 24.7951 44.5345V45.4655C24.7951 47.4677 26.4069 49.0795 28.4091 49.0795H40.9205V61.5909C40.9205 63.5931 42.5323 65.2049 44.5345 65.2049H45.4655C47.4677 65.2049 49.0795 63.5931 49.0795 61.5909V49.0795H61.5909C63.5931 49.0795 65.2049 47.4677 65.2049 45.4655V44.5345C65.2049 42.5323 63.5931 40.9205 61.5909 40.9205H49.0795V28.4091C49.0795 26.4069 47.4677 24.7951 45.4655 24.7951H44.5345Z"
                        fill="white" />
                </svg>
                <span>{% trans 'приобрести' context "lootbox" %}</span>
            </button>

            <div class="box__picBtns">

                <p class="box__picChestCount">
                    {% trans 'Количество сундуков:' context "lootbox" %} <span class="box__picChestCount--count">0</span>
                </p>

                <button class="box__picOpen10 ct__mid-btn">
                    <svg width="144" height="30" viewBox="0 0 144 30" xmlns="http://www.w3.org/2000/svg">
                        <mask id="mask0_258_219" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="144"
                            height="30">
                            <path class="geometry1" d="M0 5.76923L5.76923 0H144V23.0769L137.077 30H0V5.76923Z" />
                        </mask>
                        <g mask="url(#mask0_258_219)">
                            <path class="geometry2" fill="var(--c10two)"
                                d="M0 5.76917L5.76923 -6.10352e-05H144V23.0769L137.077 29.9999H0V5.76917Z" />
                            <path class="treg1" opacity="0.15"
                                d="M109.266 13.4468L125.407 3.59524L125.868 22.4997L109.266 13.4468Z" fill="var(--c10one)" />
                            <path class="treg2" opacity="0.15"
                                d="M95.6185 -3.53072L103.36 25.3596L74.4694 17.6185L95.6185 -3.53072Z" fill="var(--c10one)" />
                            <path class="treg3" opacity="0.15"
                                d="M22.6079 -8.73057L72.591 7.62749L33.433 42.7351L22.6079 -8.73057Z" fill="var(--c10one)" />
                        </g>
                    </svg>
                    <span>{% trans 'Открыть' context "lootbox" %}</span>
                </button>

            </div>
            <div class="war__playerDamage"></div>
        </div>

        <p class="box__desc">
            {% trans 'В этом сундуке вы можете найти:' context "lootbox" %}
        </p>

        <li class="box__altItem" style="max-width: 300rem; margin: 0 auto;  margin-bottom: 30rem;">
            <div style="display: flex;flex-direction: row;gap: 6rem;flex-grow: 1;justify-content: space-around; align-items: center">

                <div class="box__altItemLeft">
                    <span>{% trans 'шанс' context "lootbox" %}</span>
                    <span>0.001%</span>
                </div>

                <div class="box__altItemGrid">
                    <h3>$<span id="jackpot_sum">{{ budget }}</span></h3>
                </div>

                <div style="display: flex; align-items: center;">
                    3 X 
                    <img src="/static/img/planes/beluzzo/beluzzo_base.svg" alt="disk" style="width: 40rem; height: 40rem; line-height: 40rem; text-align: center; object-fit: contain; object-position: center;">
                </div>
            </div>
        </li>

        <ul class="box__altList">
            <li class="box__altItem">
                    <div class="box__altItemLeft">
                        <span>{% trans 'шанс' context "lootbox" %}</span>
                        <span>1%</span>
                    </div>
                    <div class="box__altItemRight">
                    <h3>$300 000</h3>
                    <div class="box__altItemGrid">

                        <img src="/static/img/planes/trickster/trickster_friday.svg" alt="gold">

                    </div>
                </div>
            </li>

            <li class="box__altItem">
                    <div class="box__altItemLeft">
                        <span>{% trans 'шанс' context "lootbox" %}</span>
                        <span>3%</span>
                    </div>
                    <div class="box__altItemRight">
                    <h3>$100 000</h3>
                    <div class="box__altItemGrid">

                        <img src="/static/img/planes/demolisher/demolisher_violet.svg" alt="violet">

                    </div>
                </div>
            </li>

            <li class="box__altItem">
                    <div class="box__altItemLeft">
                        <span>{% trans 'шанс' context "lootbox" %}</span>
                        <span>10%</span>
                    </div>
                    <div class="box__altItemRight">
                    <h3>$60 000</h3>
                    <div class="box__altItemGrid">

                        <img src="/static/img/planes/harrier/harrier_dark_blue.svg" alt="blue">
                    </div>
                </div>
            </li>

            <li class="box__altItem">
                    <div class="box__altItemLeft">
                        <span>{% trans 'шанс' context "lootbox" %}</span>
                        <span>24%</span>
                    </div>
                    <div class="box__altItemRight">
                    <h3>$40 000</h3>
                    <div class="box__altItemGrid">

                        <img src="/static/img/planes/pretender/pretender_green.svg" alt="green">

                    </div>
                </div>
            </li>

            <li class="box__altItem">
                    <div class="box__altItemLeft">
                        <span>{% trans 'шанс' context "lootbox" %}</span>
                        <span>62%</span>
                    </div>
                    <div class="box__altItemRight">
                    <h3>$20 000</h3>
                    <div class="box__altItemGrid">

                        <img src="/static/img/planes/nagger/nagger_base.svg" alt="green">

                    </div>
                </div>
            </li>

            <li class="box__altItem">
                    <div class="box__altItemLeft">
                        <span>{% trans 'шанс' context "lootbox" %}</span>
                        <span>0.1%</span>
                    </div>
                    <div class="box__altItemRight">
                    <h3>$10 000</h3>
                    <div class="box__altItemGrid">

                        <img src="/static/img/planes/beluzzo/beluzzo_base.svg" alt="disk">

                    </div>
                </div>
            </li>

        </ul>
    </div>
    <!-- КОНЕЦ: Блок "Мои сундуки" -->


    <!-- Блок "Приобрести" -->
    <div class="box__block">
        {% if not blocked %}
        <p class="box__desc">
            {% trans 'Наборы Ледяных сундуков за игровые средства:' context "lootbox" %}
        </p>

        <ul class="box__buyList">
            <li class="box__buyItem" style="justify-content: space-evenly;">
                <img src="/static/img/ice_chest.png" alt="">

                <div style=" display: flex; flex-direction: column;">

                <input id="count" name="count" type="number" class="search-modal__withInput-input" min="1" value="1" max="{{ limit }}">
                <span class="search-modal__withInput-text" id="stocks_value" style="font-size: 16rem;color: var(--c10two); border-bottom: 1px dashed var(--c10two); CURSOR: pointer;text-align: right;">
                    {% trans 'макс' context "lootbox" %}: {{ limit }}
                </span>
                    <script>
                        document.getElementById("stocks_value").addEventListener("click", function() {
                            const inputElement = document.getElementById("count");
                            const maxValue = inputElement.getAttribute("max"); // Получаем значение атрибута max

                            if (maxValue) {
                                inputElement.value = maxValue; // Устанавливаем значение
                                const event = new Event("input", { bubbles: true }); // Создаем событие "input"
                                inputElement.dispatchEvent(event); // Вызываем событие
                            }
                        });
                    </script>
                </div>

                <div>
                    <span style="font-size: 14rem;">$</span>
                    <span style="font-size: 14rem;" id="amount">
                        100 000
                    </span>
                </div>
            </li>
            <div class="box__buyBtnBlock">
                <button class="ct__mid-btn" id="buy_bye" onclick="cash_lootbox(1)">
                    <svg width="144" height="30" viewBox="0 0 144 30" xmlns="http://www.w3.org/2000/svg">
                        <mask id="mask0_59_315" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="144" height="30">
                            <path class="geometry1" d="M0 5.76923L5.76923 0H144V23.0769L137.077 30H0V5.76923Z"></path>
                        </mask>
                        <g mask="url(#mask0_59_315)">
                            <path class="geometry2" fill="var(--c10two)" d="M0 5.76917L5.76923 -6.10352e-05H144V23.0769L137.077 29.9999H0V5.76917Z"></path>
                            <path class="treg1" opacity="0.15" d="M109.266 13.4468L125.407 3.59524L125.868 22.4997L109.266 13.4468Z" fill="var(--c10one)"></path>
                            <path class="treg2" opacity="0.15" d="M95.6185 -3.53072L103.36 25.3596L74.4694 17.6185L95.6185 -3.53072Z" fill="var(--c10one)"></path>
                            <path class="treg3" opacity="0.15" d="M22.6079 -8.73057L72.591 7.62749L33.433 42.7351L22.6079 -8.73057Z" fill="var(--c10one)"></path>
                        </g>
                    </svg>
                    <span style="display: flex;align-items: center;gap: 5rem;">{% trans 'купить' context "lootbox" %}
                    </span>
                </button>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const countInput = document.getElementById('count');
                    const amountElement = document.getElementById('amount');
                    const buyButton = document.getElementById('buy_bye');

                    countInput.addEventListener('input', function () {
                        // Получаем текущее значение count
                        const countValue = parseInt(countInput.value, 10) || 1;

                        // Обновляем значение в элементе amount
                        amountElement.textContent = (countValue * 100000).toLocaleString();

                        // Обновляем аргумент функции buy_lootbox в кнопке
                        buyButton.setAttribute('onclick', `cash_lootbox(${countValue})`);
                    });
                });
            </script>
        </ul>
        {% else %}
        <p class="box__desc">
            {% trans 'Вы скупили все сундуки за игровые средства. Новые предложения появятся через сутки' context "lootbox" %}
        </p>
        {% endif %}

        {% if not wp_blocked %}
        <p class="box__desc" style="margin-top: 50rem;">
            {% trans 'Наборы Ледяных сундуков за Wild Pass:' context "lootbox" %}
        </p>

        <ul class="box__buyList">
            <li class="box__buyItem" style="justify-content: space-evenly;">
                <img src="/static/img/ice_chest.png" alt="">

                <div style=" display: flex; flex-direction: column;">

                <input id="wp_count" name="wp_count" type="number" class="search-modal__withInput-input" min="1" value="1" max="{{ wp_limit }}">
                <span class="search-modal__withInput-text" id="wp_stocks_value" style="font-size: 16rem;color: var(--c10two); border-bottom: 1px dashed var(--c10two); CURSOR: pointer;text-align: right;">
                    {% trans 'макс' context "lootbox" %}: {{ wp_limit }}
                </span>
                    <script>
                        document.getElementById("wp_stocks_value").addEventListener("click", function() {
                            const wp_inputElement = document.getElementById("wp_count");
                            const wp_maxValue = wp_inputElement.getAttribute("max"); // Получаем значение атрибута max

                            if (wp_maxValue) {
                                wp_inputElement.value = wp_maxValue; // Устанавливаем значение
                                const wp_event = new Event("input", { bubbles: true }); // Создаем событие "input"
                                wp_inputElement.dispatchEvent(wp_event); // Вызываем событие
                            }
                        });
                    </script>
                </div>

                <div>
                    <span style="font-size: 14rem;">X</span>
                    <span style="font-size: 14rem;" id="wp_bx_total">
                        1
                    </span>
                </div>
            </li>
            <div class="box__buyBtnBlock">
                <button class="ct__mid-btn" id="wp_buy_bye" onclick="buy_lootbox(1)">
                    <svg width="144" height="30" viewBox="0 0 144 30" xmlns="http://www.w3.org/2000/svg">
                        <mask id="mask0_59_315" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="144"
                            height="30">
                            <path class="geometry1" d="M0 5.76923L5.76923 0H144V23.0769L137.077 30H0V5.76923Z" />
                        </mask>
                        <g mask="url(#mask0_59_315)">
                            <path class="geometry2" fill="var(--c10two)"
                                d="M0 5.76917L5.76923 -6.10352e-05H144V23.0769L137.077 29.9999H0V5.76917Z" />
                            <path class="treg1" opacity="0.15"
                                d="M109.266 13.4468L125.407 3.59524L125.868 22.4997L109.266 13.4468Z" fill="var(--c10one)" />
                            <path class="treg2" opacity="0.15"
                                d="M95.6185 -3.53072L103.36 25.3596L74.4694 17.6185L95.6185 -3.53072Z" fill="var(--c10one)" />
                            <path class="treg3" opacity="0.15"
                                d="M22.6079 -8.73057L72.591 7.62749L33.433 42.7351L22.6079 -8.73057Z" fill="var(--c10one)" />
                        </g>
                    </svg>
                    <span style="display: flex;align-items: center;gap: 5rem;">
                        <span style="font-size: 18rem;" id="wp_amount">
                            1
                        </span>
                        <img src="/static/img/wild_pass.svg" alt="wild_pass" style="width: 25rem;">
                    </span>
                </button>
            </div>
        </ul>
        {% else %}
        <p class="box__desc" style="margin-top: 25rem;">
            {% trans 'Вы скупили все сундуки за Wild Pass. Новые предложения появятся через сутки' context "lootbox" %}
        </p>
        {% endif %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const wp_countInput = document.getElementById('wp_count');
                const wp_amountElement = document.getElementById('wp_amount');
                const wp_totalElement = document.getElementById('wp_bx_total');
                const wp_buyButton = document.getElementById('wp_buy_bye');

                wp_countInput.addEventListener('input', function () {
                    // Получаем текущее значение count
                    const countValue = parseInt(wp_countInput.value, 10) || 1;

                    // Обновляем значение в элементе amount
                    wp_amountElement.textContent = (countValue).toLocaleString();
                    wp_totalElement.textContent = (countValue * 10).toLocaleString();

                    // Обновляем аргумент функции buy_lootbox в кнопке
                    wp_buyButton.setAttribute('onclick', `buy_lootbox(${countValue})`);
                });
            });
        </script>
    </div>
    <!-- КОНЕЦ: Блок "Приобрести" -->

   <!-- Блок "история" -->
<!--    <div class="box__block">-->
<!--        <p class="box__desc">{% trans 'Статистика за всё время:' context "lootbox" %}</p>-->
<!--        <li class="box__buyItem" style="justify-content: center;max-width: 800rem;margin: auto;gap: 50rem;">-->

<!--            <div style="display: flex; flex-direction: column;align-items: center; ">-->
<!--                <span style="font-size: 14rem;">{% trans 'потрачено' context "lootbox" %}</span>-->
<!--                    <div style="margin-top: 10rem;">-->
<!--                    <span style="font-size: 14rem;color: tomato;">$</span>-->
<!--                    <span style="font-size: 14rem;color: tomato;">-->
<!--                        -->
<!--                    </span>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div style="display: flex; flex-direction: column; align-items: center;">-->

<!--                <span style="font-size: 14rem;">{% trans 'открыто' context "lootbox" %}</span>-->

<!--                <div style="margin-top: 10rem;">-->
<!--                    <span id="lootbox_opened" style="font-size: 14rem;">-->
<!--                        {{ lootbox_opened }}-->
<!--                    </span>-->
<!--                </div>-->

<!--            </div>-->

<!--            <div style="display: flex; flex-direction: column; align-items: center;">-->
<!--                <span style="font-size: 14rem;">{% trans 'получено' context "lootbox" %}</span>-->

<!--                <div style="margin-top: 10rem;">-->
<!--                    <span style="font-size: 14rem;color: #8DFF47;">$</span>-->
<!--                    <span id="lootbox_income" data-income="{% localize off %}{% endlocalize %}" style="font-size: 14rem;color: #8DFF47;">-->
<!--                        -->
<!--                    </span>-->

<!--                </div>-->
<!--            </div>-->
<!--        </li>-->

<!--        <p class="box__desc" style="margin-top: 24rem;margin-bottom: auto;">-->
<!--            {% trans 'Последние открытия сундуков:' context "lootbox" %}-->
<!--        </p>-->

<!--        <ul class="box__buyList" id="dummyLine" style="display: none; flex-direction: row; justify-content: space-around; gap: 15rem; margin-top: 20rem;">-->
<!--            <li class="box__buyItem" style="gap: 30rem;">-->
<!--                 <img class="carImg" src="">-->
<!--            </li>-->
<!--            <li class="box__buyItem" style="min-width: 100rem; justify-content: flex-end;">-->
<!--                <span style="font-size: 14rem;">$ </span>-->
<!--                <span class="drop" style="font-size: 14rem;">-->

<!--                </span>-->
<!--            </li>-->
<!--        </ul>-->

<!--        {% for drop in drop_data %}-->
<!--        <ul class="box__buyList" style="flex-direction: row; justify-content: space-around; gap: 15rem; margin-top: 20rem;">-->
<!--            <li class="box__buyItem" style="gap: 30rem;">-->
<!--                    {% for spin in drop %}-->
<!--                        {% if forloop.counter0 == 0 %}-->
<!--                             <img class="carImg" src="/static/img/planes/{% if spin == 'disk' %}beluzzo/beluzzo_base{% elif spin == 'gold' %}trickster/trickster_friday{% elif spin == 'violet' %}demolisher/demolisher_violet{% elif spin == 'blue' %}harrier/harrier_dark_blue{% elif spin == 'green' %}pretender/pretender_green{% elif spin == 'white' %}nagger/nagger_base{% endif %}.svg" alt="disk">-->
<!--                        {% endif %}-->
<!--                    {% endfor %}-->
<!--                    {% for spin in drop %}-->
<!--                        {% if forloop.counter0 == 2 %}-->
<!--                             <img class="carImg" src="/static/img/planes/{% if spin == 'disk' %}beluzzo/beluzzo_base{% elif spin == 'gold' %}trickster/trickster_friday{% elif spin == 'violet' %}demolisher/demolisher_violet{% elif spin == 'blue' %}harrier/harrier_dark_blue{% elif spin == 'green' %}pretender/pretender_green{% elif spin == 'white' %}nagger/nagger_base{% endif %}.svg" alt="disk">-->
<!--                        {% endif %}-->
<!--                    {% endfor %}-->
<!--                    {% for spin in drop %}-->
<!--                        {% if forloop.counter0 == 1 %}-->
<!--                             <img class="carImg" src="/static/img/planes/{% if spin == 'disk' %}beluzzo/beluzzo_base{% elif spin == 'gold' %}trickster/trickster_friday{% elif spin == 'violet' %}demolisher/demolisher_violet{% elif spin == 'blue' %}harrier/harrier_dark_blue{% elif spin == 'green' %}pretender/pretender_green{% elif spin == 'white' %}nagger/nagger_base{% endif %}.svg" alt="disk">-->
<!--                        {% endif %}-->
<!--                    {% endfor %}-->
<!--            </li>-->
<!--            <li class="box__buyItem" style="min-width: 100rem; justify-content: flex-end;">-->
<!--                <span style="font-size: 14rem;">$ </span>-->
<!--                <span style="font-size: 14rem;">-->
<!--                    {% for spin in drop %}-->
<!--                        {% if forloop.counter0 == 3 %}{{ spin }}{% endif %}-->
<!--                    {% endfor %}-->
<!--                </span>-->
<!--            </li>-->
<!--        </ul>-->
<!--        {% endfor %}-->
<!--    </div>-->

    <!-- Модалка с лутом 1на рулетка-->
    <div class="box__modal custom-scroll box__modal1">
        <button class="box__close box__close1">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L31 31M31 1L1.53571 30.4643" stroke-width="1" stroke="var(--c10one)" />
            </svg>
        </button>

        <h3 class="box__subTitle">
            {% trans 'Открываем сундук...' context "lootbox" %}
        </h3>

        <div id='carousel1' style="display: none">
            <div class='carListContainerDiv'>
                <div class=' carListContainer'>
                    <ul class='carList'>
                        <li class='carItem'>
                            <img class="carImg" src="/static/img/planes/beluzzo/beluzzo_base.svg" alt="disk">
                        </li>

                        <li class='carItem'>
                            <img class="carImg" src="/static/img/planes/trickster/trickster_friday.svg" alt="gold">
                        </li>

                        <li class='carItem'>
                            <img class="carImg" src="/static/img/planes/demolisher/demolisher_violet.svg" alt="violet">
                        </li>

                        <li class='carItem'>
                            <img class="carImg" src="/static/img/planes/harrier/harrier_dark_blue.svg" alt="blue">
                        </li>

                        <li class='carItem'>
                            <img class="carImg" src="/static/img/planes/pretender/pretender_green.svg" alt="green">
                        </li>

                        <li class='carItem'>
                            <img class="carImg" src="/static/img/planes/nagger/nagger_base.svg" alt="white">
                        </li>
                    </ul>
                </div>
            </div>

            <div class="box__modal1info box__modalInfo">
                <div class="box__modalBtns">
                </div>
            </div>
        </div>

    </div>
    <!-- КОНЕЦ: Модалка с лутом 1на рулетка -->


    <!-- Модалка с лутом 3 рулетки-->
    <div class="box__modal box__modal--3 custom-scroll box__modal3">
        <button class="box__close box__close3">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L31 31M31 1L1.53571 30.4643" stroke-width="1" stroke="var(--c10one)" />
            </svg>
        </button>

        <h3 class="box__subTitle">
            {% trans 'Открываем сундук...' context "lootbox" %}
        </h3>

        <div class="box__3carouselWrapper">
            <div id='carousel2'>
                <div class='carListContainerDiv'>
                    <div class=' carListContainer'>
                        <ul class='carList'>
                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/beluzzo/beluzzo_base.svg" alt="disk">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/trickster/trickster_friday.svg" alt="gold">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/demolisher/demolisher_violet.svg" alt="violet">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/harrier/harrier_dark_blue.svg" alt="blue">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/pretender/pretender_green.svg" alt="green">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/nagger/nagger_base.svg" alt="white">
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id='carousel3'>
                <div class='carListContainerDiv'>
                    <div class=' carListContainer'>
                        <ul class='carList'>
                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/beluzzo/beluzzo_base.svg" alt="disk">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/trickster/trickster_friday.svg" alt="gold">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/demolisher/demolisher_violet.svg" alt="violet">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/harrier/harrier_dark_blue.svg" alt="blue">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/pretender/pretender_green.svg" alt="green">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/nagger/nagger_base.svg" alt="white">
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id='carousel4'>
                <div class='carListContainerDiv'>
                    <div class=' carListContainer'>
                        <ul class='carList'>
                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/beluzzo/beluzzo_base.svg" alt="disk">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/trickster/trickster_friday.svg" alt="gold">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/demolisher/demolisher_violet.svg" alt="violet">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/harrier/harrier_dark_blue.svg" alt="blue">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/pretender/pretender_green.svg" alt="green">
                            </li>

                            <li class='carItem'>
                                <img class="carImg" src="/static/img/planes/nagger/nagger_base.svg" alt="white">
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="box__modal3info box__modalInfo">
                    <p class='box__modalDesc'><span id="prize_name"></span></p>

                    <div class="box__modalBtns">
                        <button class="box__picOpen ct__mid-btn" id='modal__continue3'>
                            <svg width="144" height="30" viewBox="0 0 144 30" xmlns="http://www.w3.org/2000/svg">
                                <mask id="mask0_258_2341" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="144"
                                    height="30">
                                    <path class="geometry1" d="M0 5.76923L5.76923 0H144V23.0769L137.077 30H0V5.76923Z" />
                                </mask>
                                <g mask="url(#mask0_258_2341)">
                                    <path class="geometry2" fill="var(--c10two)"
                                        d="M0 5.76917L5.76923 -6.10352e-05H144V23.0769L137.077 29.9999H0V5.76917Z" />
                                    <path class="treg1" opacity="0.15"
                                        d="M109.266 13.4468L125.407 3.59524L125.868 22.4997L109.266 13.4468Z" fill="var(--c10one)" />
                                    <path class="treg2" opacity="0.15"
                                        d="M95.6185 -3.53072L103.36 25.3596L74.4694 17.6185L95.6185 -3.53072Z" fill="var(--c10one)" />
                                    <path class="treg3" opacity="0.15"
                                        d="M22.6079 -8.73057L72.591 7.62749L33.433 42.7351L22.6079 -8.73057Z" fill="var(--c10one)" />
                                </g>
                            </svg>
                            <span>{% trans 'Продолжить' context "lootbox" %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- КОНЕЦ: Модалка с лутом 3 рулетки -->

    <div class="box__modal box__modal--noCenter custom-scroll" id='flyModal1'>
        <button class="box__close">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L31 31M31 1L1.53571 30.4643" stroke-width="1" stroke="var(--c10one)" />
            </svg>
        </button>

        <style>
          .box__DropCombinations {
                gap: 6rem;
                display: flex;
                flex-direction: row;
          }
          .box__DropCombinations img {
                object-fit: contain;
                object-position: center;
                width: 100%;
                height: 100%;
          }
        </style>
        <div class="box__DropCombinations">
            <img src="/static/img/planes/nagger/nagger_base.svg" alt="nagger">
        </div>
    </div>

    <div class="wp-loader-wrapper">
        <span class="wp-loader"></span>
    </div>

</section>
{% endblock %}

{% block for_scripts_and_css %}


<script>
        // Функция для клонирования элемента и заполнения данными
<!--        function cloneAndFillDummyLine(imagesToAdd, dropText) {-->
<!--            // Найти элемент dummyLine-->
<!--            const dummyLine = document.getElementById("dummyLine");-->
<!--            if (!dummyLine) {-->
<!--                console.error("Элемент с id 'dummyLine' не найден.");-->
<!--                return;-->
<!--            }-->

<!--            // Клонировать dummyLine-->
<!--            const newLine = dummyLine.cloneNode(true);-->

<!--            // Удалить атрибут display: none;-->
<!--            newLine.style.display = "flex";-->

<!--            // Найти целевой элемент для добавления img-->
<!--            const carListItem = newLine.querySelector('li[style*="gap: 30rem;"]');-->
<!--            if (!carListItem) {-->
<!--                console.error("Не найден целевой элемент для добавления img.");-->
<!--                return;-->
<!--            }-->

<!--            // Очищаем существующие элементы img в li-->
<!--            carListItem.innerHTML = "";-->

<!--            // Источник данных для картинок-->
<!--            const carItems = [-->
<!--                { src: "/static/img/planes/beluzzo/beluzzo_base.svg", alt: "disk" },-->
<!--                { src: "/static/img/planes/trickster/trickster_friday.svg", alt: "gold" },-->
<!--                { src: "/static/img/planes/demolisher/demolisher_violet.svg", alt: "violet" },-->
<!--                { src: "/static/img/planes/harrier/harrier_dark_blue.svg", alt: "blue" },-->
<!--                { src: "/static/img/planes/pretender/pretender_green.svg", alt: "green" },-->
<!--                { src: "/static/img/planes/nagger/nagger_base.svg", alt: "white" }-->
<!--            ];-->

<!--            // Добавить новые изображения из списка-->
<!--            imagesToAdd.forEach((alt) => {-->
<!--                const carItem = carItems.find((item) => item.alt === alt);-->
<!--                if (carItem) {-->
<!--                    const img = document.createElement("img");-->
<!--                    img.className = "carImg";-->
<!--                    img.src = carItem.src;-->
<!--                    img.alt = carItem.alt;-->
<!--                    carListItem.appendChild(img);-->
<!--                }-->
<!--            });-->

<!--            // Найти элемент drop и заполнить его текстом-->
<!--            const dropElement = newLine.querySelector(".drop");-->
<!--            if (dropElement) {-->
<!--                dropElement.textContent = dropText;-->
<!--            } else {-->
<!--                console.error("Элемент с классом 'drop' не найден.");-->
<!--            }-->

<!--            // Вставить новый элемент после dummyLine-->
<!--            dummyLine.parentNode.insertBefore(newLine, dummyLine.nextSibling);-->
<!--        }-->

        // сундуки - использование
        function buy_lootbox(count){
            var sending_data = "&csrfmiddlewaretoken=" + csrftoken + "&count=" + count;
            $.ajax({
                type: "POST",
                url: "/buy_lootboxes/",
                data:  sending_data,
                cache: false,
                success: function(data){
                    if (data.response == 'ok'){
                        location.reload();
                    }
                    else{
                        display_modal('notify', data.header, data.response, null, data.grey_btn);
                    }
                }
            });
        };

        // сундуки - использование
        function cash_lootbox(count){
            var sending_data = "&csrfmiddlewaretoken=" + csrftoken + "&count=" + count;
            $.ajax({
                type: "POST",
                url: "/cash_lootboxes/",
                data:  sending_data,
                cache: false,
                success: function(data){
                    if (data.response == 'ok'){
                        location.reload();
                    }
                    else{
                        display_modal('notify', data.header, data.response, null, data.grey_btn);
                    }
                }
            });
        };


		class Carousel {
			constructor(containerId) {
				this.container = document.getElementById(containerId);
				this.list = this.container.querySelector('.carList');
				this.itemsArr1 = [...this.container.querySelectorAll('.carItem')];
				this.modalInfo1 = this.container.querySelector('.box__modal1info');
				this.modalInfo3 = this.container.querySelector('.box__modal3info');

				const itemWidth = document.querySelector('.carImg').getBoundingClientRect().width;
			}

			shuffle(array) {
				const arr = [...array];
				let currentIndex = arr.length;
				while (currentIndex != 0) {
					let randomIndex = Math.floor(Math.random() * currentIndex);
					currentIndex--;
					[arr[currentIndex], arr[randomIndex]] = [
						arr[randomIndex], arr[currentIndex]];
				}
				return arr;
			}

			shuffleItems() {
				this.itemsArr2 = this.shuffle(this.itemsArr1);
				this.itemsArr3 = this.shuffle(this.itemsArr1);
			}

			appendItems() {
				this.itemsArr2.forEach((item) => this.list.appendChild(item.cloneNode(true)));
				this.itemsArr3.forEach((item) => this.list.appendChild(item.cloneNode(true)));
            }

            startCarousel(targetImageName) {
                // Hide all images initially
                this.itemsArr1.forEach(item => {
                    const img = item.querySelector('img');
                    if (img) {
                        img.style.display = 'none';
                    }
                });

                // Find and show the target image
                const targetIndex = this.itemsArr1.findIndex(item => {
                    const img = item.querySelector('img');
                    return img && img.alt === targetImageName;
                });

                if (targetIndex !== -1) {
                    const targetImg = this.itemsArr1[targetIndex].querySelector('img');
                    if (targetImg) {
                        targetImg.style.display = '';
                    }

                    // Center the target image
                    const itemsLendth = this.itemsArr1.length;
                    const offset = 60;
                    this.list.style.transform = `translateX(${offset}px)`;
                    this.list.style.transition = 'none';
                }

                // Update list content to match itemsArr1
                while (this.list.firstChild) {
                    this.list.removeChild(this.list.firstChild);
                }
                this.itemsArr1.forEach(item => this.list.appendChild(item.cloneNode(true)));

                // Optionally activate modals if necessary
                if (boxPage.state.isPopup1Opened && this.modalInfo1) {
                    this.modalInfo1.classList.add('active');
                }
                if (boxPage.state.isPopup3Opened && this.modalInfo3) {
                    this.modalInfo3.classList.add('active');
                }
            }

		}

		const carousel1 = new Carousel('carousel1');
		const carousel2 = new Carousel('carousel2');
		const carousel3 = new Carousel('carousel3');
		const carousel4 = new Carousel('carousel4');

	</script>

	<script>
        // сундук - запустить открытие
        function open_aviaboxes(){
            var sending_data = "&csrfmiddlewaretoken=" + csrftoken;

            return fetch("/open_aviaboxes/", {
              "headers": {
                "accept": "*/*",
                "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
              },
              "body": sending_data,
              "method": "POST",
              "credentials": "include"
            });
        };

		const sleep = (time) => {
			return new Promise((res) => {
				setTimeout(() => res(), time);
			});
		};

		class BoxPage {
			constructor() {
				this.plusBtn = document.querySelector('.box__picBtn');
				this.tabs = document.querySelectorAll('.ct__top-tab');
				this.blocks = document.querySelectorAll('.box__block');

				this.chestImg = document.querySelector('.box__picImg');
				this.goToBuyBtn = document.querySelector('.box__picBtn');

				this.openChestBtns = document.querySelector('.box__picBtns');
				this.openChestBtn = document.querySelector('.box__picOpen');
				this.openChest10Btn = document.querySelector('.box__picOpen10');
				this.openChestAllBtn = document.querySelector('.box__picOpenAll');

				this.popup1 = document.querySelector('.box__modal1');
				this.popupClose1 = document.querySelector('.box__close1');
				this.popup3 = document.querySelector('.box__modal3');
				this.popupClose3 = document.querySelector('.box__close3');

				this.popup3continue = document.getElementById('modal__continue3');
<!--				this.popup3restart = document.getElementById('modal__restart3');-->

				this.goldContent = document.querySelector('.box__itemCount--gold');
				this.premContent = document.querySelector('.box__itemCount--prem');
				this.wpContent = document.querySelector('.box__itemCount--wp');

				this.chestCountContainer = document.querySelector('.box__picChestCount');
				this.chestCount = document.querySelector('.box__picChestCount--count');

				this.loader = document.querySelector('.wp-loader-wrapper');

				this.stateData = {
					currentBlock: 0, //какой текущий блок показывается 0 или 1
					chestCount: {% localize off %}{{ lootbox_count }}{% endlocalize %}, //сколько у чувака сундуков
					isPopup1Opened: false, //открыт ли попап с 1 наградами
					isPopup3Opened: false, //открыт ли попап с 3 наградами
					goldReward: '', //сколько золота в награде
					premReward: '', //сколько према в награде
					wpReward: '', //сколько wild pass'ов в награде
					isLoading: false, //идет ли загрузка запроса
				};

				const rerender = {
					set: (obj, prop, value) => {
						switch (prop) {
							case "currentBlock":
                                for (let i = 0; i < 2; i++) {
                                    if (value === i) {
                                        this.tabs[i].classList.add('active');
                                        this.blocks[i].classList.add('active');
                                    } else {
                                        this.tabs[i].classList.remove('active');
                                        this.blocks[i].classList.remove('active');
                                    }
                                }
                                obj[prop] = value;
                                return true;

							case "chestCount":
								value === 0 ? this.goToBuyBtn.style.display = '' : this.goToBuyBtn.style.display = 'none';
								value === 0 ? this.chestImg.style.filter = 'grayscale(1)' : this.chestImg.style.filter = 'grayscale(0)';
								value === 0 ? this.openChestBtns.style.display = 'none' : this.openChestBtns.style.display = '';
								value > 0 ? this.chestCountContainer.style.display = '' : this.chestCountContainer.style.display = 'none';
								if (value > 0) this.chestCount.textContent = value;
								obj[prop] = value; return true;

							case "isPopup1Opened":
								value ? this.popup1.classList.add('active') : this.popup1.classList.remove('active');
								obj[prop] = value; return true;

							case "isPopup3Opened":
								value ? this.popup3.classList.add('active') : this.popup3.classList.remove('active');
								obj[prop] = value; return true;

							case "goldReward":
								value ? this.goldContent.parentNode.style.display = '' : this.goldContent.parentNode.style.display = 'none';
								this.goldContent.textContent = value;
								obj[prop] = value; return true;

							case "premReward":
								value ? this.premContent.parentNode.style.display = '' : this.premContent.parentNode.style.display = 'none';
								this.premContent.textContent = value;
								obj[prop] = value; return true;

							case "wpReward":
								value ? this.wpContent.parentNode.style.display = '' : this.wpContent.parentNode.style.display = 'none';
								this.wpContent.textContent = value;
								obj[prop] = value; return true;

							case "isLoading":
								value ? this.loader.classList.add('active') : this.loader.classList.remove('active');
								obj[prop] = value; return true;
						}
					}
				};

				this.state = new Proxy(this.stateData, rerender);

				this.setEventListeners();
				this.state.isLoading = false;
				this.state.chestCount = {% localize off %}{{ lootbox_count }}{% endlocalize %};
			}

			setEventListeners() {
				this.goToBuyBtn.addEventListener('click', () => this.state.currentBlock = 1);
				this.tabs[0].addEventListener('click', () => this.state.currentBlock = 0);
				this.tabs[1].addEventListener('click', () => this.state.currentBlock = 1);
<!--				this.tabs[2].addEventListener('click', () => this.state.currentBlock = 2);-->
				this.popupClose1.addEventListener('click', () => {
					this.state.isPopup1Opened = false;
					carousel1.modalInfo1.classList.remove('active');
					carousel1.cancelTransitionRemove();
				});

				this.popupClose3.addEventListener('click', () => {
					this.state.isPopup3Opened = false;
					carousel4.modalInfo3.classList.remove('active');
					carousel4.cancelTransitionRemove();
				});
				this.popup3continue.addEventListener('click', () => this.state.isPopup3Opened = false);


				this.openChest10Btn.addEventListener('click', async () => {

                    var response = await open_aviaboxes();

				    var data = await response.json();

                    if(data !== null){
                        if (data.response == 'ok'){
                            actualize();

                            this.state.isPopup3Opened = true;

                            carousel1.startCarousel(
                                    data.prizes[0]
                                                );

                            carousel2.startCarousel(
                                    data.prizes[0]
                                                );
                            carousel3.startCarousel(
                                    data.prizes[1]
                                                );
                            carousel4.startCarousel(
                                    data.prizes[2]
                                                );

                            document.getElementById("prize_name").innerHTML = numberWithSpaces(data.reward);
                            this.state.chestCount = data.boxes_count;

<!--                            cloneAndFillDummyLine([data.prizes[0], data.prizes[2], data.prizes[1]], numberWithSpaces(data.reward.replace(/\$/g, "")));-->

                            const lootboxOpened = document.getElementById("lootbox_opened");
                            if (lootboxOpened) {
                                const currentValue = parseInt(lootboxOpened.textContent, 10) || 0;
                                lootboxOpened.textContent = numberWithSpaces(currentValue + 1);
                            }

                            const lootboxIncome = document.getElementById("lootbox_income");
                            if (lootboxIncome) {
                                const currentIncome = parseInt(lootboxIncome.getAttribute("data-income"), 10) || 0;

                                const newIncome = currentIncome + parseInt(data.reward.replace(/\$/g, "").replace(/\D/g, ""));
                                lootboxIncome.setAttribute("data-income", newIncome);
                                lootboxIncome.textContent = numberWithSpaces(newIncome);
                            }
                        }
                        else{
                            display_modal('notify', data.header, data.response, null, data.grey_btn);
                        }
                    };
				});

			}
		}

		const boxPage = new BoxPage();

		/* модалки с самолётами */
		const flyModal1 = document.getElementById('flyModal1');

		const flyModal1Close = flyModal1.querySelector('.box__close');

		flyModal1Close.addEventListener('click', () => { flyModal1.classList.remove('active'); });
</script>

<script>
	/* создание выскакивающего сообщения */
	const messagesContainer = document.querySelector('.war__playerDamage');
	function createDamageMessage(src, points, isLeft) {
		const newMessage = document.createElement('div');
		isLeft ? newMessage.classList.add('left') : newMessage.classList.add('right');
		isLeft ?
			newMessage.insertAdjacentHTML('beforeend', `<img src="${src}"><span>+${points.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ")}</span>`)
			:
			newMessage.insertAdjacentHTML('beforeend', `<span>+${points.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ")}</span><img src="${src}">`);
		messagesContainer.appendChild(newMessage);
		setTimeout(() => newMessage.remove(), 5000);
	}
</script>
{% endblock %}